<?php


                    
                   
/** @var string[] $form alle Formularfelder */
$form = [];

/** @var string[] $fehler Fehlermeldungen für Formularfelder */
$fehler = [];

/** @var string $datendatei Pfad und Dateiname der Datei zum Speichern der Datensätze */
$datendatei = './veranstaltun.csv';

// Formularwerte holen
$form['vid'] = !empty($_GET['vid']) ? htmlspecialchars(trim($_GET['vid'])) : '';
$form['name'] = !empty($_GET['name']) ? htmlspecialchars(trim($_GET['name'])) : '';
$form['oid'] = !empty($_GET['oid']) ? htmlspecialchars(trim($_GET['oid'])) : '';
$form['plz'] = !empty($_GET['plz']) ? htmlspecialchars(trim($_GET['plz'])) : '';
$form['adresse'] = !empty($_GET['adresse']) ? htmlspecialchars(trim($_GET['adresse'])) : '';
$form['beschreibung'] = !empty($_GET['beschreibung']) ? htmlspecialchars(trim($_GET['beschreibung'])) : '';
$form['datum'] = !empty($_GET['datum']) ? htmlspecialchars(trim($_GET['datum'])) : '';

/*
 * Prüfen, ob Formular abgeschickt wurde
 * Falls ja, dann weitere Prüfungen durchführen
 */
if (isset($_GET['okbutton'])) {
    // Anrede prüfen
    // name prüfen
    if (!$form['name']) {
        $fehler['name'] = 'Bitte Namen eingeben';
    } elseif (strlen($form['name']) < 2) {
        $fehler['name'] = 'Veranstaltungsname muss mindestens zwei Zeichen lang sein';
    }


    // Postleitzahl prüfen
    if (!$form['plz']) {
        $fehler['plz'] = 'Bitte PLZ eingeben';
    } elseif (intval($form['plz']) < 100 || intval($form['plz']) > 99999) {
        $fehler['plz'] = 'Bitte eine gültige deutsche PLZ eingeben';
    }

    // Ort prüfen
    if (!$form['ort']) {
        $fehler['ort'] = 'Bitte Ort eingeben';
    }

    // Datum prüfen
    if (!$form['datum']) {
        $fehler['datum'] = 'Bitte Datum eingeben';
    } else {
        // Geburtsdatum extrahieren
        $jahr = substr($form['datum'], 0, 4);
        $monat = substr($form['datum'], 5, 2);
        $tag = substr($form['datum'], 8, 2);
        // Datum auf allgemeine Gültigkeit prüfen
        if (!checkdate($monat, $tag, $jahr)) {
            $fehler['datum'] = 'Bitte gültiges Datum eingeben';
        }
        // Prüfen, Datum nicht in der Vergangenheit liegt
        else {
            $achtzehn = mktime(0, 0, 0, date('n'), date('j'), intval(date('Y')) - 18);
            $geburtstag = mktime(0, 0, 0, $monat, $tag, $jahr);
            if ($geburtstag > $achtzehn) {
                $fehler['datum'] = 'Datum liegt in der Vergangenheit';
            }
        }
    }

    // Wenn keine Fehler aufgetreten sind ...
    if (!count($fehler)) {
        // 1. Datenbank öffnen
        $db = mysqli_connect(DBSERVER, DBUSER, DBPASSWD, DBNAME);

        // 2. SQL-Statement erzeugen
        /*
         * HEREDOC-Schreibweise
         * Hinter der Anfangsmarke darf NICHTS stehen (auch kein Leerzeichen)
         * Die Endemarke muss in einer eigenen Zeile GANZ VORNE stehen (auch darf nichts dahinter stehen)
         */
        $sql = <<<EOT
                INSERT INTO adressen
                (vid, name, oid, plz, adresse, datum)
                VALUES ('{$form['vid']}', 
                        '{$form['name']}',
                        '{$form['beschreibung']}',
                        '{$form['oid']}',
                        '{$form['adresse']}',
                        '{$form['plz']}',
                        '{$form['datum']}')
EOT;

        // 3. SQL-Statement an DB schicken
        mysqli_query($db, $sql);

        // 4. Erzeugte ID des Datensatzes ermitteln
        $id = mysqli_insert_id($db);

        // 5. Schließen der DB
        mysqli_close($db);

        // Weiterleiten auf Erfolgsseite und Programm beenden
        header('location: veranstaltung-ok.php?id=' . $id);
        die;
    }
}
$ausgabe['titel'] = 'Veranstaltung Hinzufügen';
include TEMPLATES . 'htmlkopf.phtml';
?>
        <form action="<?= $_SERVER['PHP_SELF'] ?>" method="get">


<?php
$ausgabe['feldname'] = 'nasme';
$ausgabe['beschriftung'] = 'Veranstaltung';
$ausgabe['typ'] = 'text';
include TEMPLATES . 'inputfeldadd.phtml';
?>



            <div>
                <label for="plz" class="pflicht">PLZ</label>
                <input type="text" name="plz" id="plz" value="<?= $form['plz'] ?>">
                <span><?= $fehler['plz'] ?? '' ?></span>
            </div>

            <div>
                <label for="ort" class="pflicht">Ort</label>
                <input type="text" name="ort" id="ort" value="<?= $form['ort'] ?>">
                <span><?= $fehler['ort'] ?? '' ?></span>
            </div>

            <div>
                <label for="telefon">Telefon</label>
                <input type="text" name="telefon" id="telefon" value="<?= $form['telefon'] ?>">
                <span><?= $fehler['telefon'] ?? '' ?></span>
            </div>

            <div>
                <label for="geburtsdatum" class="pflicht">Geburtsdatum</label>
                <input type="date" name="geburtsdatum" id="geburtsdatum" value="<?= $form['geburtsdatum'] ?>">
                <span><?= $fehler['geburtsdatum'] ?? '' ?></span>
            </div>

            <div>
                <button type="submit" name="okbutton" value="1">speichern</button>
            </div>

            <div class='formcaption'>Felder in <span class='pflicht'>blau</span> sind Pflichtfelder</div>
     <?php
include TEMPLATES . 'htmlfuss.phtml';

?>